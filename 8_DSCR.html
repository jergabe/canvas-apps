<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRE Finance: Dual Criteria Underwriting</title>
    <style>
        :root {
            --primary: #003366; /* Academic Blue */
            --accent: #4CAF50; /* Success Green */
            --error: #f44336; /* Error Red */
            --light: #f5f5f5;
        }
        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 { color: var(--primary); }
        .section {
            margin-bottom: 25px;
            padding: 15px;
            border-left: 4px solid var(--primary);
            background-color: var(--light);
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover { background-color: #002244; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .feedback.success { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .feedback.error { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .feedback.hint { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }

        .hidden { display: none; }
        
        .scenario-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .scenario-item {
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .scenario-label { font-size: 0.85em; color: #666; }
        .scenario-value { font-weight: bold; font-size: 1.1em; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <h1>CRE Loan Underwriting Practice</h1>
    <p>Determine the maximum loan amount based on the "Dual Criteria" of Loan-to-Value (LTV) and Debt Service Coverage Ratio (DSCR).</p>

    <!-- Step 0: Identity -->
    <div id="identity-section" class="section">
        <label for="codeword">Enter your Codeword:</label>
        <input type="text" id="codeword" placeholder="e.g., FirstnameLastname123">
        <button onclick="startGame()">Start Scenario</button>
    </div>

    <!-- Scenario Display -->
    <div id="scenario-section" class="section hidden">
        <h3>Property & Loan Scenario</h3>
        <div class="scenario-grid">
            <div class="scenario-item">
                <div class="scenario-label">Annual NOI</div>
                <div class="scenario-value" id="disp-noi"></div>
            </div>
            <div class="scenario-item">
                <div class="scenario-label">Market Cap Rate</div>
                <div class="scenario-value" id="disp-cap"></div>
            </div>
            <div class="scenario-item">
                <div class="scenario-label">Interest Rate</div>
                <div class="scenario-value" id="disp-rate"></div>
            </div>
            <div class="scenario-item">
                <div class="scenario-label">Amortization</div>
                <div class="scenario-value">25 Years</div>
            </div>
            <div class="scenario-item">
                <div class="scenario-label">Max LTV</div>
                <div class="scenario-value" id="disp-ltv"></div>
            </div>
            <div class="scenario-item">
                <div class="scenario-label">Min DSCR</div>
                <div class="scenario-value" id="disp-dscr"></div>
            </div>
        </div>
    </div>

    <!-- Question 1: Price -->
    <div id="q1-section" class="section hidden">
        <label>1. Estimate the Property Price ($):</label>
        <input type="number" id="ans-price" placeholder="Enter amount">
        <button onclick="checkStep(1)">Check Price</button>
        <div id="feedback-1" class="feedback"></div>
    </div>

    <!-- Question 2: LTV Loan -->
    <div id="q2-section" class="section hidden">
        <label>2. Calculate Max Loan based on LTV ($):</label>
        <input type="number" id="ans-ltv-loan" placeholder="Enter amount">
        <button onclick="checkStep(2)">Check LTV Loan</button>
        <div id="feedback-2" class="feedback"></div>
    </div>

    <!-- Question 3: DSCR Max Payment -->
    <div id="q3-section" class="section hidden">
        <label>3. Calculate Max Allowable MONTHLY Payment ($):</label>
        <input type="number" id="ans-dscr-pmt" placeholder="Enter amount">
        <button onclick="checkStep(3)">Check Payment</button>
        <div id="feedback-3" class="feedback"></div>
    </div>

    <!-- Question 4: DSCR Loan -->
    <div id="q4-section" class="section hidden">
        <label>4. Calculate Max Loan based on DSCR ($):</label>
        <p style="font-size:0.9em; color:#666;">(Use the PV formula with your Max Monthly Payment)</p>
        <input type="number" id="ans-dscr-loan" placeholder="Enter amount">
        <button onclick="checkStep(4)">Check DSCR Loan</button>
        <div id="feedback-4" class="feedback"></div>
    </div>

    <!-- Question 5: Final Decision -->
    <div id="q5-section" class="section hidden">
        <label>5. Which is the Maximum Loan Amount the borrower can receive?</label>
        <select id="ans-decision">
            <option value="">-- Select One --</option>
            <option value="LTV">LTV-Determined Loan</option>
            <option value="DSCR">DSCR-Determined Loan</option>
        </select>
        <button onclick="checkStep(5)">Submit Final Answer</button>
        <div id="feedback-5" class="feedback"></div>
    </div>

    <!-- Success Message -->
    <div id="completion-section" class="section hidden" style="text-align: center;">
        <h2 style="color:var(--accent)">Exercise Complete!</h2>
        <p>Your results have been recorded.</p>
        <button onclick="location.reload()">New Scenario</button>
    </div>

</div>

<script>
    // --- CONFIGURATION ---
    // PASTE YOUR DEPLOYED GOOGLE APPS SCRIPT URL HERE
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzE3EES0ilQ8iLQPXx12DABB8J5nq6klExE9sKhlRBq-7QvDO4E8tz0etY2PV28QorL/exec"; 

    // --- STATE MANAGEMENT ---
    let state = {
        codeword: "",
        noi: 0,
        capRate: 0,
        intRate: 0,
        ltvMax: 0,
        dscrMin: 0,
        attempts: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
        correctValues: {}
    };

    // --- UTILITIES ---
    const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
    const formatPercent = (num) => (num * 100).toFixed(2) + "%";
    
    // Random integer inclusive
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // --- INITIALIZATION ---
    function startGame() {
        const codeword = document.getElementById('codeword').value.trim();
        if (!codeword) {
            alert("Please enter a codeword to identify yourself.");
            return;
        }
        state.codeword = codeword;
        
        // Hide ID section, Generate Scenario, Show Q1
        document.getElementById('identity-section').classList.add('hidden');
        generateScenario();
        document.getElementById('scenario-section').classList.remove('hidden');
        document.getElementById('q1-section').classList.remove('hidden');
    }

    function generateScenario() {
        // PROBABILITY ENGINEERING
        const forceDSCRBinding = Math.random() < 0.65;
        
        // 1. Generate NOI ($100k - $700k, step $10k)
        state.noi = getRandomInt(10, 70) * 10000;

        // 2. Set Parameters based on bias
        if (forceDSCRBinding) {
            // Bucket A: High Rate, Low Cap, High LTV, High DSCR Requirement
            state.capRate = getRandomInt(40, 55) / 1000; // 4.0% - 5.5%
            state.intRate = getRandomInt(14, 18) / 200;  // 7.0% - 9.0%
            state.ltvMax = getRandomInt(13, 15) * 0.05;  // 65% - 75%
            state.dscrMin = getRandomInt(27, 30) * 0.05; // 1.35 - 1.50
        } else {
            // Bucket B: Low Rate, High Cap, Low LTV, Low DSCR Requirement
            state.capRate = getRandomInt(55, 70) / 1000; // 5.5% - 7.0%
            state.intRate = getRandomInt(10, 13) / 200;  // 5.0% - 6.5%
            state.ltvMax = getRandomInt(10, 12) * 0.05;  // 50% - 60%
            state.dscrMin = getRandomInt(24, 26) * 0.05; // 1.20 - 1.30
        }

        // --- CALCULATE CORRECT ANSWERS ---
        const price = state.noi / state.capRate;
        const ltvLoan = price * state.ltvMax;
        
        const annualDebtService = state.noi / state.dscrMin;
        const monthlyPmt = annualDebtService / 12;
        
        // PV Calculation: PV(rate/12, nper, -pmt)
        const nper = 25 * 12; // 25 years
        const r = state.intRate / 12;
        const dscrLoan = monthlyPmt * (1 - Math.pow(1 + r, -nper)) / r;

        const winningLoan = Math.min(ltvLoan, dscrLoan);
        const winningType = (dscrLoan < ltvLoan) ? "DSCR" : "LTV";

        state.correctValues = {
            price: price,
            ltvLoan: ltvLoan,
            monthlyPmt: monthlyPmt,
            dscrLoan: dscrLoan,
            winningLoan: winningLoan,
            winningType: winningType
        };

        // --- RENDER SCENARIO ---
        document.getElementById('disp-noi').innerText = formatCurrency(state.noi);
        document.getElementById('disp-cap').innerText = formatPercent(state.capRate);
        document.getElementById('disp-rate').innerText = formatPercent(state.intRate);
        document.getElementById('disp-ltv').innerText = formatPercent(state.ltvMax);
        document.getElementById('disp-dscr').innerText = state.dscrMin.toFixed(2) + "x";
    }

    // --- CHECK LOGIC ---

    function checkStep(step) {
        state.attempts[step]++;
        const feedbackEl = document.getElementById(`feedback-${step}`);
        feedbackEl.style.display = 'block';
        feedbackEl.className = 'feedback'; 

        let isCorrect = false;
        let userVal, correctVal;
        
        if (step === 1) {
            userVal = parseFloat(document.getElementById('ans-price').value);
            correctVal = state.correctValues.price;
            isCorrect = isCloseEnough(userVal, correctVal);
        } else if (step === 2) {
            userVal = parseFloat(document.getElementById('ans-ltv-loan').value);
            correctVal = state.correctValues.ltvLoan;
            isCorrect = isCloseEnough(userVal, correctVal);
        } else if (step === 3) {
            userVal = parseFloat(document.getElementById('ans-dscr-pmt').value);
            correctVal = state.correctValues.monthlyPmt;
            isCorrect = isCloseEnough(userVal, correctVal);
        } else if (step === 4) {
            userVal = parseFloat(document.getElementById('ans-dscr-loan').value);
            correctVal = state.correctValues.dscrLoan;
            isCorrect = isCloseEnough(userVal, correctVal);
        } else if (step === 5) {
            userVal = document.getElementById('ans-decision').value;
            correctVal = state.correctValues.winningType;
            isCorrect = (userVal === correctVal);
        }

        if (isCorrect) {
            feedbackEl.classList.add('success');
            feedbackEl.innerHTML = `<strong>Correct!</strong> Great job.`;
            lockSection(step);
            if (step < 5) {
                document.getElementById(`q${step+1}-section`).classList.remove('hidden');
            } else {
                finishGame();
            }
        } else {
            if (state.attempts[step] === 1) {
                feedbackEl.classList.add('hint');
                let specificHint = null;
                if (step === 3) {
                    const annualVal = state.correctValues.monthlyPmt * 12;
                    if (isCloseEnough(userVal, annualVal)) {
                        specificHint = "<strong>Hint:</strong> It looks like you calculated the Annual Debt Service. The question asks for the <strong>MONTHLY</strong> payment.";
                    }
                }
                feedbackEl.innerHTML = specificHint || getHint(step);
            } else {
                feedbackEl.classList.add('error');
                feedbackEl.innerHTML = getWalkthrough(step);
                fillCorrectAnswer(step);
                lockSection(step);
                if (step < 5) {
                    document.getElementById(`q${step+1}-section`).classList.remove('hidden');
                } else {
                    finishGame();
                }
            }
        }
    }

    function isCloseEnough(a, b) {
        if (!a && a !== 0) return false;
        return Math.abs(a - b) <= 5;
    }

    function lockSection(step) {
        const section = document.getElementById(`q${step}-section`);
        const inputs = section.querySelectorAll('input, select, button');
        inputs.forEach(el => el.disabled = true);
    }

    function fillCorrectAnswer(step) {
        if (step === 1) document.getElementById('ans-price').value = state.correctValues.price.toFixed(2);
        if (step === 2) document.getElementById('ans-ltv-loan').value = state.correctValues.ltvLoan.toFixed(2);
        if (step === 3) document.getElementById('ans-dscr-pmt').value = state.correctValues.monthlyPmt.toFixed(2);
        if (step === 4) document.getElementById('ans-dscr-loan').value = state.correctValues.dscrLoan.toFixed(2);
        if (step === 5) document.getElementById('ans-decision').value = state.correctValues.winningType;
    }

    function getHint(step) {
        switch(step) {
            case 1: return "<strong>Hint:</strong> Use the basic capitalization formula. Look closely at the Annual NOI and the Market Cap Rate.";
            case 2: return "<strong>Hint:</strong> This is a simple multiplication. Take the Property Price you just calculated and apply the LTV limit.";
            case 3: return "<strong>Hint:</strong> Start with Annual NOI and divide by the DSCR to get the annual payment capacity. Don't forget to convert to monthly.";
            case 4: return `<strong>Hint:</strong> You are calculating the Present Value (PV) of an annuity. <br>Rate = ${(state.intRate*100).toFixed(2)}%/12 <br>NPER = 300 <br>PMT = -${state.correctValues.monthlyPmt.toFixed(2)}`;
            case 5: return "<strong>Hint:</strong> The bank wants to minimize risk. If the LTV calculation allows $10M but the DSCR calculation only allows $8M, which one will the bank choose?";
        }
    }

    function getWalkthrough(step) {
        switch(step) {
            case 1: return `<strong>Solution:</strong> The Price is NOI divided by Cap Rate. <br> $${state.noi.toLocaleString()} / ${state.capRate} = <strong>${formatCurrency(state.correctValues.price)}</strong>.`;
            case 2: return `<strong>Solution:</strong> The LTV Loan is Price multiplied by Max LTV. <br> ${formatCurrency(state.correctValues.price)} * ${state.ltvMax} = <strong>${formatCurrency(state.correctValues.ltvLoan)}</strong>.`;
            case 3: return `<strong>Solution:</strong> <br>1. Max Annual Debt Service = NOI / DSCR = $${state.noi.toLocaleString()} / ${state.dscrMin} = ${formatCurrency(state.noi/state.dscrMin)} <br>2. Monthly = Annual / 12 = <strong>${formatCurrency(state.correctValues.monthlyPmt)}</strong>.`;
            case 4: return `<strong>Solution:</strong> Using the PV formula on the monthly payment: <br> Rate per month: ${(state.intRate/12).toFixed(6)} <br> Months: 300 <br> Max Monthly Payment: ${formatCurrency(state.correctValues.monthlyPmt)} <br> Result: <strong>${formatCurrency(state.correctValues.dscrLoan)}</strong>.`;
            case 5: return `<strong>Solution:</strong> The bank chooses the lower of the two options. <br> LTV Loan: ${formatCurrency(state.correctValues.ltvLoan)} <br> DSCR Loan: ${formatCurrency(state.correctValues.dscrLoan)} <br> The correct answer is <strong>${state.correctValues.winningType}-Determined Loan</strong>.`;
        }
    }

    // --- DATA SUBMISSION (UPDATED TO POST) ---
    function finishGame() {
        document.getElementById('completion-section').classList.remove('hidden');
        
        const payload = {
            codeword: state.codeword,
            noi: state.noi,
            capRate: state.capRate,
            intRate: state.intRate,
            ltvMax: state.ltvMax,
            dscrMin: state.dscrMin,
            correctPrice: state.correctValues.price,
            correctLTVLoan: state.correctValues.ltvLoan,
            correctDSCRLoan: state.correctValues.dscrLoan,
            winningType: state.correctValues.winningType,
            attempts: JSON.stringify(state.attempts)
        };

        if(GOOGLE_SCRIPT_URL.includes("PLACEHOLDER")) {
            console.log("Data ready to send (Script URL not set):", payload);
        } else {
            // Using POST with text/plain to avoid CORS preflight issues on Google Apps Script
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: {
                    "Content-Type": "text/plain" 
                },
                body: JSON.stringify(payload)
            }).then(() => {
                console.log("Data submitted successfully");
            }).catch(e => console.error("Error sending data", e));
        }
    }

</script>

</body>
</html>
