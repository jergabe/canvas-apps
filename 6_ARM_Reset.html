<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARM Loan Calculator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0"
        }
    }
    </script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState } from 'react';
        import { createRoot } from 'react-dom/client';
        import { AlertCircle, CheckCircle, Calculator, ChevronRight, Save, RotateCcw } from 'lucide-react';

        // --- CONFIGURATION ---
        // INSTRUCTION: Deploy the Google Script and paste the "Web App URL" below.
        // It should look like: "https://script.google.com/macros/s/.../exec"
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxMYgBoHlnwWQFHbjhKrs2cUj0zKkgUoFqppEAjWwUEx0cUshEb6dLbiqPMQozi0N7M/exec"; 

        // --- MATH HELPERS ---
        const PMT = (rate, nper, pv) => {
            if (rate === 0) return -(pv / nper);
            const pvif = Math.pow(1 + rate, nper);
            return (rate * pv * pvif) / (pvif - 1);
        };

        const FV = (rate, nper, pmt, pv) => {
            if (rate === 0) return pv - pmt * nper;
            const factor = Math.pow(1 + rate, nper);
            return (pv * factor) - (pmt * (factor - 1) / rate);
        };

        // --- MAIN APP ---

        function ARMCalculator() {
            // App State
            const [step, setStep] = useState('welcome');
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [codeword, setCodeword] = useState('');
            
            // Simulation Data
            const [params, setParams] = useState(null);
            const [questions, setQuestions] = useState([]);
            
            // User Progress
            const [inputVal, setInputVal] = useState('');
            const [attempts, setAttempts] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [history, setHistory] = useState([]);
            const [isSaving, setIsSaving] = useState(false);
            const [saveError, setSaveError] = useState(null);

            const generateSimulation = () => {
                const armTypes = [5, 7, 10];
                const fixedYears = armTypes[Math.floor(Math.random() * armTypes.length)];
                const armLabel = `${fixedYears}/1 ARM`;

                // Params
                const steps = (8.0 - 5.0) / 0.125;
                const initialRatePct = 5.0 + (Math.floor(Math.random() * (steps + 1)) * 0.125);
                
                const amountSteps = (1000000 - 500000) / 10000;
                const loanAmount = 500000 + (Math.floor(Math.random() * (amountSteps + 1)) * 10000);

                const termMonths = 360;
                const margin = 0.0275;

                const sofr1Pct = (Math.random() * (6.0 - 2.0) + 2.0).toFixed(2);
                const sofr2Pct = (Math.random() * (6.0 - 2.0) + 2.0).toFixed(2);

                // Calculations
                const initialRate = initialRatePct / 100;
                const sofr1 = parseFloat(sofr1Pct) / 100;
                const sofr2 = parseFloat(sofr2Pct) / 100;

                // Q1
                const pmt1 = PMT(initialRate / 12, termMonths, loanAmount);

                // Q2
                const fixedMonths = fixedYears * 12;
                const bal1 = (loanAmount * Math.pow(1 + initialRate / 12, fixedMonths)) - 
                             (pmt1 * (Math.pow(1 + initialRate / 12, fixedMonths) - 1) / (initialRate / 12));

                // Q3
                const rate2 = sofr1 + margin;
                const pmt2 = PMT(rate2 / 12, termMonths - fixedMonths, bal1);

                // Q4
                const bal2 = (bal1 * Math.pow(1 + rate2 / 12, 12)) - 
                             (pmt2 * (Math.pow(1 + rate2 / 12, 12) - 1) / (rate2 / 12));
                
                // Q5
                const rate3 = sofr2 + margin;
                const pmt3 = PMT(rate3 / 12, termMonths - fixedMonths - 12, bal2);

                setParams({
                    armLabel,
                    initialRatePct: initialRatePct.toFixed(3),
                    loanAmount,
                    marginPct: (margin * 100).toFixed(2),
                    sofr1Pct,
                    sofr2Pct,
                    fixedYears
                });

                const qList = [
                    {
                        id: 'q1',
                        title: 'Step 1: Initial Monthly Payment',
                        text: `Calculate the monthly mortgage payment for the initial ${fixedYears}-year fixed period.`,
                        correct: pmt1,
                        tolerance: 2.0,
                        excelHint: `=PMT(${initialRatePct.toFixed(3)}%/12, 360, -${loanAmount})`
                    },
                    {
                        id: 'q2',
                        title: 'Step 2: Balance at First Reset',
                        text: `Calculate the outstanding loan balance at the end of Year ${fixedYears}.`,
                        correct: bal1,
                        tolerance: 10.0,
                        excelHint: `=FV(${initialRatePct.toFixed(3)}%/12, ${fixedMonths}, ${pmt1.toFixed(2)}, -${loanAmount})`
                    },
                    {
                        id: 'q3',
                        title: 'Step 3: New Payment at First Reset',
                        text: `Rate resets to SOFR (${sofr1Pct}%) + Margin (2.75%). Remaining term: ${30 - fixedYears} years.`,
                        correct: pmt2,
                        tolerance: 2.0,
                        excelHint: `=PMT((${sofr1Pct}% + 2.75%)/12, ${360 - fixedMonths}, -${bal1.toFixed(2)})`
                    },
                    {
                        id: 'q4',
                        title: 'Step 4: Balance at Second Reset',
                        text: `One year passes. Calculate balance at end of Year ${fixedYears + 1}.`,
                        correct: bal2,
                        tolerance: 10.0,
                        excelHint: `=FV((${sofr1Pct}% + 2.75%)/12, 12, ${pmt2.toFixed(2)}, -${bal1.toFixed(2)})`
                    },
                    {
                        id: 'q5',
                        title: 'Step 5: New Payment at Second Reset',
                        text: `Rate resets to SOFR (${sofr2Pct}%) + Margin (2.75%). Remaining term: ${30 - fixedYears - 1} years.`,
                        correct: pmt3,
                        tolerance: 2.0,
                        excelHint: `=PMT((${sofr2Pct}% + 2.75%)/12, ${360 - fixedMonths - 12}, -${bal2.toFixed(2)})`
                    }
                ];

                setQuestions(qList);
                setStep('active');
                setAttempts(0);
                setFeedback(null);
                setHistory([]);
                setInputVal('');
                setCurrentQuestionIndex(0);
            };

            const handleStart = (e) => {
                e.preventDefault();
                if (!codeword.trim()) return;
                generateSimulation();
            };

            const handleSubmitAnswer = () => {
                const userNum = parseFloat(inputVal.replace(/[$,]/g, ''));
                if (isNaN(userNum)) {
                    setFeedback({ type: 'error', message: 'Please enter a valid number.' });
                    return;
                }

                const currentQ = questions[currentQuestionIndex];
                const diff = Math.abs(userNum - currentQ.correct);
                const isCorrect = diff <= currentQ.tolerance;

                if (isCorrect) {
                    setFeedback({ type: 'success', message: 'Correct!', showAnswer: false });
                    setTimeout(() => proceedToNext(true, userNum), 1500);
                } else {
                    const newAttempts = attempts + 1;
                    setAttempts(newAttempts);

                    if (newAttempts === 1) {
                        setFeedback({
                            type: 'error',
                            message: `Incorrect. Attempt 1/2 failed. Hint: ${currentQ.excelHint}`,
                            showAnswer: false
                        });
                    } else {
                        setFeedback({
                            type: 'error',
                            message: `Incorrect. The correct answer was $${formatNumber(currentQ.correct)}.`,
                            showAnswer: true,
                            excelInputs: currentQ.excelHint
                        });
                    }
                }
            };

            const proceedToNext = (wasCorrect, userResponse) => {
                const currentQ = questions[currentQuestionIndex];
                const resultEntry = {
                    stepId: currentQ.id,
                    question: currentQ.title,
                    correct: wasCorrect,
                    correctAnswer: currentQ.correct,
                    userResponse: userResponse || parseFloat(inputVal.replace(/[$,]/g, '')),
                    attemptsUsed: wasCorrect ? attempts + 1 : 2
                };

                const newHistory = [...history, resultEntry];
                setHistory(newHistory);

                if (currentQuestionIndex < questions.length - 1) {
                    setCurrentQuestionIndex(prev => prev + 1);
                    setAttempts(0);
                    setFeedback(null);
                    setInputVal('');
                } else {
                    finishSimulation(newHistory);
                }
            };

            const forceNext = () => proceedToNext(false, null);

            const finishSimulation = async (finalHistory) => {
                setStep('summary');
                setIsSaving(true);
                setSaveError(null);

                if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes("PASTE_YOUR")) {
                    setSaveError("Configuration Error: Google Script URL not set in index.html");
                    setIsSaving(false);
                    return;
                }

                const allCorrect = finalHistory.every(h => h.correct);
                const payload = {
                    codeword: codeword,
                    passedAll: allCorrect,
                    params: params,
                    history: finalHistory
                };

                try {
                    // We use 'no-cors' mode which is standard for submitting to Google Forms/Scripts
                    // However, we can't read the response in 'no-cors'.
                    // To read response, we need CORS headers on the Google Script side (which we added).
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    // If no error thrown, assume success
                } catch (err) {
                    console.error("Save Error", err);
                    setSaveError("Failed to save to Google Sheet. Check your internet connection.");
                }
                setIsSaving(false);
            };

            const formatNumber = (num) => num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            if (step === 'welcome') {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans text-gray-800">
                        <div className="bg-white max-w-md w-full rounded-xl shadow-lg p-8">
                            <div className="flex justify-center mb-6">
                                <div className="bg-blue-100 p-4 rounded-full">
                                    <Calculator className="w-8 h-8 text-blue-600" />
                                </div>
                            </div>
                            <h1 className="text-2xl font-bold text-center mb-2">ARM Loan Calculator</h1>
                            <p className="text-gray-600 text-center mb-6">Practice calculating payments for ARM resets.</p>
                            <form onSubmit={handleStart} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Codeword</label>
                                    <input type="text" required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. BLUE-LION" value={codeword} onChange={(e) => setCodeword(e.target.value)} />
                                </div>
                                <button type="submit" disabled={!codeword.trim()} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition disabled:opacity-50 flex items-center justify-center gap-2">
                                    Start Practice <ChevronRight size={18} />
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            if (step === 'active') {
                const currentQ = questions[currentQuestionIndex];
                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col items-center p-4 font-sans text-gray-800">
                        <div className="w-full max-w-2xl bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
                            <div className="flex justify-between items-center mb-2">
                                <span className="font-bold text-gray-700">Student: {codeword}</span>
                                <span className="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">Q: {currentQuestionIndex + 1} / {questions.length}</span>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm bg-gray-50 p-3 rounded-lg border border-gray-100">
                                <div><span className="block text-gray-500 text-xs uppercase">Product</span><span className="font-semibold">{params.armLabel}</span></div>
                                <div><span className="block text-gray-500 text-xs uppercase">Loan</span><span className="font-semibold">${params.loanAmount.toLocaleString()}</span></div>
                                <div><span className="block text-gray-500 text-xs uppercase">Init Rate</span><span className="font-semibold">{params.initialRatePct}%</span></div>
                                <div><span className="block text-gray-500 text-xs uppercase">Margin</span><span className="font-semibold">{params.marginPct}%</span></div>
                            </div>
                        </div>

                        <div className="w-full max-w-2xl bg-white rounded-xl shadow-lg overflow-hidden">
                            <div className="bg-blue-600 px-6 py-4"><h2 className="text-white text-lg font-bold">{currentQ.title}</h2></div>
                            <div className="p-6">
                                <p className="text-gray-700 text-lg mb-6 leading-relaxed">{currentQ.text}</p>
                                <div className="mb-6">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Your Answer</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                                        <input type="text" disabled={feedback && feedback.showAnswer} className={`w-full pl-8 pr-4 py-3 text-lg border rounded-lg focus:ring-2 outline-none ${feedback?.type === 'error' ? 'border-red-300 focus:ring-red-200' : 'border-gray-300 focus:ring-blue-500'}`} placeholder="0.00" value={inputVal} onChange={(e) => setInputVal(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && !feedback?.showAnswer && handleSubmitAnswer()} />
                                    </div>
                                </div>
                                {feedback && (
                                    <div className={`mb-6 p-4 rounded-lg flex items-start gap-3 ${feedback.type === 'error' ? 'bg-red-50 text-red-800' : 'bg-green-50 text-green-800'}`}>
                                        {feedback.type === 'error' ? <AlertCircle className="shrink-0 mt-0.5" /> : <CheckCircle className="shrink-0 mt-0.5" />}
                                        <div className="flex-1">
                                            <p className="font-medium">{feedback.message}</p>
                                            {feedback.showAnswer && (
                                                <div className="mt-3 text-sm bg-white bg-opacity-60 p-3 rounded border border-red-100">
                                                    <p className="font-semibold mb-1">Correct Calculation:</p>
                                                    <code className="bg-gray-800 text-gray-100 px-2 py-1 rounded block w-full overflow-x-auto">{feedback.excelInputs}</code>
                                                    <p className="mt-2 text-xs text-gray-600">Exact value: ${formatNumber(currentQ.correct)}</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                                <div className="flex justify-end">
                                    {feedback?.showAnswer ? (
                                        <button onClick={forceNext} className="bg-gray-800 hover:bg-gray-900 text-white px-6 py-2 rounded-lg font-medium transition flex items-center gap-2">Continue <ChevronRight size={18} /></button>
                                    ) : (
                                        <button onClick={handleSubmitAnswer} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition shadow-sm">Submit Answer</button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (step === 'summary') {
                const correctCount = history.filter(h => h.correct).length;
                const score = Math.round((correctCount / history.length) * 100);
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans text-gray-800">
                        <div className="bg-white max-w-2xl w-full rounded-xl shadow-lg p-8">
                            <div className="text-center mb-8">
                                <div className={`inline-flex p-4 rounded-full mb-4 ${score === 100 ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'}`}>
                                    {score === 100 ? <CheckCircle size={48} /> : <AlertCircle size={48} />}
                                </div>
                                <h1 className="text-3xl font-bold mb-2">Practice Complete</h1>
                                <p className="text-gray-600">You scored {score}% ({correctCount}/{history.length} correct)</p>
                                {isSaving && <p className="text-sm text-blue-500 mt-2 flex items-center justify-center gap-2"><Save size={14} className="animate-spin"/> Saving results to Google Sheets...</p>}
                                {saveError && <p className="text-sm text-red-500 mt-2 font-bold">{saveError}</p>}
                                {!isSaving && !saveError && <p className="text-sm text-green-600 mt-2 font-bold">Results saved successfully!</p>}
                            </div>
                            <div className="flex justify-center">
                                <button onClick={() => setStep('welcome')} className="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium transition">
                                    <RotateCcw size={18} /> Start New Practice
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
            return null;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<ARMCalculator />);
    </script>
</body>
</html>
